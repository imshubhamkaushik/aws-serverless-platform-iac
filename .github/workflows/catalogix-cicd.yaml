name: Catalogix CI/CD

on:
  push:
    branches: ["main"]

# Prevent overlapping deployments - Equivalent to Jenkins:
# options { disableConcurrentBuilds() }
concurrency:
  group: catalogix-main
  cancel-in-progress: true

# Global permissions (recommended best practice)
permissions:
  id-token: write # Required for AWS OIDC
  contents: read

# Global environment variables
env:
  AWS_REGION: ap-south-1
  APP_NAME: catalogix
  MAJOR_VERSION: "1.0"

jobs:
  # # Phase 0: Scan Base Images (Upstream Risk Awareness)
  # scan-base-images:
  #   name: Scan Base Images (Non-blocking)
  #   runs-on: ubuntu-latest

  #   strategy:
  #     matrix:
  #       image:
  #         - eclipse-temurin:17-jre
  #         - node:18-alpine
  #         - nginx:alpine

  #   steps:
  #     - name: Trivy Scan Base Image
  #       uses: aquasecurity/trivy-action@master
  #       continue-on-error: true  # Intentional: visibility without blocking
  #       with:
  #         image-ref: ${{ matrix.image }}
  #         severity: CRITICAL,HIGH
  #         ignore-unfixed: true
  #         format: table

  # Phase 1: Build & Test (Quality Gate)
  build-and-test:
    name: Build & Test (Backend + Frontend)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # -------- Backend (Java) --------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build & Test User Service
        run: mvn -B -f user-svc/pom.xml clean verify

      - name: Build & Test Product Service
        run: mvn -B -f product-svc/pom.xml clean verify

      # -------- Optional SonarQube (kept but non-blocking) --------
      # Enable only when SonarQube infra is ready
      #
      # - name: SonarQube Scan (Backend)
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     mvn sonar:sonar \
      #       -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
      #       -Dsonar.login=$SONAR_TOKEN

      # -------- Frontend (Node.js) --------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
          cache-dependency-path: frontend-svc/package-lock.json

      - name: Build Frontend
        run: |
          cd frontend-svc
          npm ci
          npm run build

  # Phase 2: Docker Build, Security Scan & Push to ECR
  docker-build-scan-push:
    name: Docker Build, Scan & Push
    runs-on: ubuntu-latest
    needs: build-and-test

    strategy:
      matrix:
        service:
          - user-svc
          - product-svc
          - frontend-svc

    steps:
      - name: Set Image Tag Variable
        run: echo "IMAGE_TAG=${{ env.MAJOR_VERSION }}-${{ github.run_number }}" >> $GITHUB_ENV
      - name: Checkout source code
        uses: actions/checkout@v4

      # -------- AWS Auth via OIDC (No IAM User, No Keys) --------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # -------- Ensure ECR Repository Exists --------
      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names ${{ matrix.service }} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository --repository-name ${{ matrix.service }} --region ${{ env.AWS_REGION }}

      # -------- Login to Amazon ECR --------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # -------- Build & Tag Docker Image --------
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:$IMAGE_TAG \
            ./${{ matrix.service }}

      # -------- Application Image Security Scan (Trivy) --------
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:${{env.IMAGE_TAG}}
          format: table
          severity: CRITICAL,HIGH
          exit-code: "1"
          ignore-unfixed: true

      # -------- Push Image to ECR --------
      - name: Push image to ECR
        run: |
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:${IMAGE_TAG}

      # -------- Deploy to ECS --------
      - name: Deploy to ECS
        env:
          CLUSTER_NAME: catalogix-cluster
          SERVICE_NAME: ${{ matrix.service }}
          TASK_FAMILY: ${{ matrix.service }}
        run: |
          set -e

          echo "Fetching current task definition for $TASK_FAMILY"

          TASK_DEF_JSON=$(aws ecs describe-task-definition \
            --task-definition $TASK_FAMILY \
            --query taskDefinition)

          echo "Updating container image"

          NEW_TASK_DEF=$(echo "$TASK_DEF_JSON" | jq \
            --arg IMAGE "${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:${IMAGE_TAG}" \
            '.containerDefinitions[0].image = $IMAGE
             | del(
                 .taskDefinitionArn,
                 .revision,
                 .status,
                 .requiresAttributes,
                 .compatibilities,
                 .registeredAt,
                 .registeredBy
               )')

          echo "Registering new task definition revision"

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "Updating ECS service to new task definition"

          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $SERVICE_NAME \
            --task-definition $NEW_TASK_DEF_ARN

          echo "Deployment triggered for $SERVICE_NAME"
